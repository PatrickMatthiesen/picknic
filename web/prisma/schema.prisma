// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MembershipRole {
  OWNER
  MEMBER
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum ShoppingItemSource {
  AUTO
  MANUAL
}

enum ShoppingItemStatus {
  PENDING
  BOUGHT
  SKIPPED
}

model User {
  id              String            @id @default(cuid())
  workosUserId    String            @unique
  email           String            @unique
  displayName     String?
  households      HouseholdMember[]
  mealPlans       MealPlan[]
  pantryItems     PantryItem[]
  recipes         Recipe[]
  shoppingLists   ShoppingList[]
  ownedHouseholds Household[]       @relation("HouseholdOwner")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model Household {
  id                   String            @id @default(cuid())
  name                 String
  workosOrganizationId String?           @unique
  ownerId              String
  owner                User              @relation("HouseholdOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  members              HouseholdMember[]
  mealPlans            MealPlan[]
  pantryItems          PantryItem[]
  recipes              Recipe[]
  shoppingLists        ShoppingList[]
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
}

model HouseholdMember {
  id          String         @id @default(cuid())
  householdId String
  userId      String
  role        MembershipRole @default(MEMBER)
  household   Household      @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([householdId, userId])
}

model Recipe {
  id          String             @id @default(cuid())
  householdId String
  createdById String
  title       String
  description String?
  servings    Int                @default(1)
  tags        String[]           @default([])
  household   Household          @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy   User               @relation(fields: [createdById], references: [id], onDelete: Restrict)
  ingredients RecipeIngredient[]
  steps       RecipeStep[]
  plannedIn   MealPlanEntry[]
  listItems   ShoppingListItem[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model RecipeIngredient {
  id        String   @id @default(cuid())
  recipeId  String
  name      String
  quantity  Decimal? @db.Decimal(10, 2)
  unit      String?
  position  Int
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([recipeId, position])
}

model RecipeStep {
  id          String   @id @default(cuid())
  recipeId    String
  instruction String
  position    Int
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([recipeId, position])
}

model MealPlan {
  id           String          @id @default(cuid())
  householdId  String
  createdById  String
  weekStart    DateTime
  household    Household       @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy    User            @relation(fields: [createdById], references: [id], onDelete: Restrict)
  entries      MealPlanEntry[]
  shoppingList ShoppingList?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([householdId, weekStart])
}

model MealPlanEntry {
  id               String   @id @default(cuid())
  mealPlanId       String
  recipeId         String
  date             DateTime
  mealType         MealType
  servingsOverride Int?
  mealPlan         MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe           Recipe   @relation(fields: [recipeId], references: [id], onDelete: Restrict)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([mealPlanId, date, mealType])
}

model ShoppingList {
  id          String             @id @default(cuid())
  householdId String
  mealPlanId  String?            @unique
  createdById String
  name        String
  household   Household          @relation(fields: [householdId], references: [id], onDelete: Cascade)
  mealPlan    MealPlan?          @relation(fields: [mealPlanId], references: [id], onDelete: SetNull)
  createdBy   User               @relation(fields: [createdById], references: [id], onDelete: Restrict)
  items       ShoppingListItem[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model ShoppingListItem {
  id             String             @id @default(cuid())
  shoppingListId String
  recipeId       String?
  ingredientName String
  quantity       Decimal?           @db.Decimal(10, 2)
  unit           String?
  source         ShoppingItemSource @default(AUTO)
  status         ShoppingItemStatus @default(PENDING)
  shoppingList   ShoppingList       @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  recipe         Recipe?            @relation(fields: [recipeId], references: [id], onDelete: SetNull)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

model PantryItem {
  id             String    @id @default(cuid())
  householdId    String
  userId         String
  ingredientName String
  quantity       Decimal   @db.Decimal(10, 2)
  unit           String
  expiresAt      DateTime?
  household      Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([householdId, ingredientName, unit])
}
